<!doctype html>
<html lang="en">
<!-- index.html -->
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"
    name="viewport">
<link rel="stylesheet" href="slides.css">
<script src="../reveal/lib/js/head.min.js"></script>

<title>Fedora CI: Building an OS that always works </title>
</head>
<body>

<div class="reveal">
<div class="slides">

    <!-- INTRO -->

    <section data-state="title" class="title">
        <h3>Fedora CI<br>
            Building an OS that always works<br>
            DevConf 2018</h3>
        <br>
        <br>
        <p><strong>Dominik Perpeet, Rachel Sibley, Serhii Turivny</strong><br>
        Red Hat</p>
    </section>

    <section>
        <h3><strong>Goal:</strong> Composition of packages in Fedora is "always ready"</h3>
        <aside class="notes">

        </aside>
    </section>

    <section class="left">
      <h4>That means <strong>packages</strong> are...</h4>
      <ul style="padding-left: 3em; list-style: none; line-height: 250%;">
          <li><strong>functioning</strong></li>
          <li><strong>integrated</strong></li>
          <li><strong>coherent</strong> with one another</li>
      </ul>
        <aside class="notes">

        </aside>
    </section>

    <section data-transition="fade-in fade-out" style="top: 244.5px; display: block;" class="present">
        <h2 style="font-weight: 700; color: #999;">Continuous <strong>Integration</strong></h2>
        Assemble everything together like in production,<br>and then drive it like a user.
    </section>

    <section class="left">
        <ul style="padding-left: 5em; list-style: none; line-height: 250%;">
            <li><span><strong>Broken packages gated</strong> close to the change</span></li>
            <li><span><strong>Curate tests</strong> in a standard way</span></li>
            <li><span>Grow <strong>responsibility for tests</strong></span></li>
        </ul>
    </section>

    <section>
        <img src="How-Meme.jpg">
        <aside class="notes">
            How?
        </aside>
    </section>

    <section data-background-image="merge.png">
        <h3><strong>Goal:</strong> Make tests as easy<br>
            to update as the package</h3>
        <aside class="notes">
            Pagure
        </aside>
    </section>

    <section data-background-image="open-source.png">
        <h3><strong>Goal:</strong> Curate tests<br> like we curate source code</h3>
    </section>

    <section>
        <h3>We're storing our tests in dist-git</h3>
        <aside class="notes">
            Tests get updated with package
        </aside>
    </section>

    <section data-background-image="manifesto.png">
        <h3>We share responsibility for the tests</h3>
    </section>

    <section data-background-image="gate.png">
        <h3>Goal: We find and <strong>fix bugs while the code is fresh</strong><br>
        in our mind rather than months or years later.</h3>
    </section>

    <section>
        <h2><strong>Where</strong> <span>are we?</span></h2>
    </section>

    <section>
        <img src="fedora-atomic-945x400.png" style="margin: 3em 0;"><br>
        <div class="caption">Started with Fedora Atomic Host</div>
    </section>

    <section data-background="#000">
        <img src="ls-rpm-ostree-dist-git.png" style="margin: 5em 0;">
        <div class="caption">Step: The tests are stored in dist-git</div>
    </section>

    <section>
        <img src="pagure-screenshot.png">
        <div class="caption">Step: Let's update a package</div>
    </section>

    <section>
        Step: A git push triggers the pipeline<br>
    </section>

    <section>
        Step: A Fedmsg is generated when this happens<br>
    </section>

    <section>
        <img src="pipeline-openshift-services.png" style="margin: 5em 0;">
        <div class="caption">Step: Pipeline runs using Openshift in CentOS CI</div>
    </section>

    <section>
        <img src="pipeline-jenkins-screenshot.png" >
        <div class="caption">Step: Jenkins schedules the pipeline</div>
    </section>

    <section>
        Step: Basic unit tests are run
    </section>

    <section>
        <img src="pipeline-jenkins-compose.png" style="margin: 2.5em 0;">
        <div class='caption'>Step: An Atomic Host is composed</div>
    </section>

    <section>
        <img src="Invoking-tests-standard-interface.png" style="padding: 2em 0 2em 0;">
        <h3><a href="https://fedoraproject.org/wiki/Changes/InvokingTests">fedoraproject.org/wiki/Changes/InvokingTests</a></h3>
    </section>

    <section>
        <img src="pipeline-fedmsg-integration-complete.png" style="margin: 0 0 2em 0;">
        <div class='caption'>Step: Fedmsg is generated when the job is done</div>
    </section>

    <section>
        Step: Results are stored in resultsdb
    </section>

    <section>
        Step: Greenwave is used to read resultsdb
    </section>

    <section>
        <img src="pagure_commit_AtomicCi_combined.png" height="800">
        <div class='caption'>Step: Results are displayed in Pagure</div>
    </section>

    <section>
        <img src="pipeline-bodhi-gating.png">
        <div class='caption'>Step: Results are displayed in Bodhi</div>
    </section>

    <section>
        <img src="pipeline-bodhi-failed.png">
        <div class='caption'>Step: Bodhi gates on the results</div>
    </section>

    <section>
        <h2><strong>When?</strong> <span>Next steps</span></h2>
    </section>

    <section data-background-image="diagram.png">
    </section>

    <section class="left">
        <h3>Wheeeee!</h3>
        <ul style="padding-left: 3em; list-style: none; line-height: 250%;">
            <li>Pull request testing in Pagure</li>
            <li>Non Atomic Host packages</li>
        </ul>
    </section>

    <section>
        <img src="How-Meme.jpg">
        <aside class="notes">
            How?
        </aside>
    </section>

    <section>
        <h3>We're storing our tests in dist-git</h3>
        <aside class="notes">
            Tests get updated with package
        </aside>
    </section>

    <section data-background-image="manifesto.png">
        <h3>We share responsibility for the tests</h3>
    </section>

    <section data-background-image="manifesto.png">
        <h3>Tests are updated together with source</h3>
    </section>

    <section>
        <h3>Tests are distinct from the testing system</h3>
        <aside class="notes">
            Tests need to outlive the testing system.
        </aside>
    </section>

    <section>
        <h2>The spec</h2>
        <img src="Invoking-tests-standard-interface.png" style="padding: 2em 0 2em 0;">
        <h3><a href="https://fedoraproject.org/wiki/Changes/InvokingTests">fedoraproject.org/wiki/Changes/InvokingTests</a></h3>
    </section>

    <section>
        <h3>Testing system is responsible to:</h3>

        <ul style="text-align: left; padding-left: 6em; line-height: 180%;">
            <li>Build test subject (package, container, image, tree)</li>
            <li>Decide which test suites</li>
            <li>Schedule job(s)</li>
            <li>Stage the test suites</li>
            <li>Invoke the test suites in a standard way</li>
            <li>Gather the test results and test artifacts</li>
            <li>Relay test results</li>
        </ul>
    </section>

    <section>
        <h3>Standard interface describes how to:</h3>

        <ul style="text-align: left; padding-left: 6em; line-height: 180%;">
            <li>Uniquely identify a test suite</li>
            <li>Stage a test suite and its dependencies</li>
            <li>Provide test subject to test suite</li>
            <li>Invoke a test suite in a consistent way</li>
            <li>Gather test results and test artifacts</li>
        </ul>
    </section>

    <section style="text-align: left; padding-left: 2em;">
        <h3>Test suite is responsible to:</h3>

        <ul style="line-height: 180%; padding-left: 2em;">
            <li>Install dependencies such as a test framework</li>
            <li>Execute the test framework as necessary</li>
            <li>Provision (usually locally) any containers or virtual machines</li>
            <li>Provide test results and test artifacts</li>
        </ul>
    </section>

    <section>
        <img src="ansible-1.png">
        <h1>Ansible!</h1>
    </section>

    <section>
<pre style="text-align: left; padding-left: 10em;">
 ________________________
< TASK [Gathering Facts] >
 ------------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
</pre>
    </section>

<!-- Upstream First part -->

    <section>
        <h3>Let's talk about tests !</h3>
    </section>

    <section style="text-align: left; padding-left: 2em;">
        <h3>Upstream First</h3>

        <ul style="text-align: left; padding-left: 6em; line-height: 180%;">
            <li>Migration of internal RHEL tests upstream into Fedora</li>
            <li>Dedicated agile team</li>
            <li>Coordination within RHEL QE</li>
            <li>Priority is the BaseOS</li>
        </ul>
    </section>

    <section style="text-align: left; padding-left: 2em;">
        <h3>Benefits</h3>

        <ul style="text-align: left; padding-left: 6em; line-height: 180%;">
	    <li>Test Early, Test Often</li>
	    <li>Discover defects sooner</li>
	    <li>Saves time</li>
	    <li>Engagement with the community</li>
        </ul>
    </section>

    <section style="text-align: left; padding-left: 2em;">
        <h3>Guidelines</h3>

        <ul style="text-align: left; padding-left: 6em; line-height: 180%;">
            <li>No exposing of internal locations</li>
            <li>No customer data</li>
            <li>No private bugzillas or security reproducers</li>
            <li>Adhere to legal requirements</li>
            <li>Must contain a LICENSE file or similar</li>
        </ul>
    </section>

     <section style="text-align: left; padding-left: 2em;">
        <h3>Selection of tests</h3>

        <ul style="text-align: left; padding-left: 6em; line-height: 180%;">
            <li>Priority is Tier1</li>
            <li>Testing should be limited to the component</li>
            <li>Postive/happy path</li>
            <li>Reliable and consistent results</li>
        </ul>
    </section>

    <section style="text-align: left; padding-left: 2em;">
        <h3>Conform to the Standard Test Interface</h3>

        <ul style="text-align: left; padding-left: 6em; line-height: 180%;">
            <li>Tests are stored in /tests directory</li>
            <li>Playbooks are named tests*.yml</li>
            <li>Test in all contexts (container, atomic, classic)</li>
            <li>Use of tags to determine the environment</li>
            <li>Use standard-test-roles pkg to prepare the environment</li>
        </ul>
    </section>

    <section style="text-align: left; padding-left: 2em;">
        <h3>Beakerlib Libraries</h3>

        <ul style="text-align: left; padding-left: 6em; line-height: 180%;">
            <li>Many beakerlib tests are dependent on libraries</li>
            <li>Built in copr and invoked in the standard-rhts role</li>
            <li>Libraries should be named component/library_name</li>
            <li>The name should be unique</li>
            <li>copr repo: https://pagure.io/beakerlib-libraries/tree/master</li>
        </ul>
    </section>

    <section>
        <img src="beakerlib-lib.png">
    </section>

    <section style="text-align: left; padding-left: 2em;">
        <h3>Staging of tests</h3>

        <ul style="text-align: left; padding-left: 6em; line-height: 180%;">
            <li>Separate Pagure instance created to stage our tests</li>
            <li>Check to see where it passes</li>
            <li>Downstream CI job to flag/report issues</li>
            <li>No issues? Time to file a PR !</li>
        </ul>
    </section>

    <section style="text-align: left; padding-left: 2em;">
        <h3>Challenges we face</h3>

        <ul style="text-align: left; padding-left: 6em; line-height: 180%;">
            <li>Porting tests takes time</li>
            <li>Dependent on reviews from others</li>
            <li>Testing in all environments</li>
            <li>Open source ready state</li>
            <li>Reworking the tests</li>
        </ul>
    </section>

    <section>
        <h3>Roles & Responsibilites</h3>
    </section>

    <section style="text-align: left; padding-left: 2em;">
        <h3>Devel</h3>

        <ul style="text-align: left; padding-left: 6em; line-height: 180%;">
	    <li>Support QE as a priority</li>
	    <li>Help QE with migration as needed</li>
	    <li>Help maintain/fix tests which require updates</li>
	    <li>Contribute to test development for new features</li>
        </ul>
    </section>

    <section style="text-align: left; padding-left: 2em;">
        <h3>QE</h3>

        <ul style="text-align: left; padding-left: 6em; line-height: 180%;">
	    <li>Support Devel as a priority</li>
	    <li>Define best practices and guidelines</li>
	    <li>Review/Approve new tests to be open sourced</li>
	    <li>Bridge the gap between devel and QE</li>
        </ul>
    </section>

    <section>
        <h3>Progress we've made</h3>
    </section>

    <section>
        <img src="upstreamstaging.png">
    </section>

    <section>
        <img src="stats.png">
    </section>


<!-- section with examples, practical -->

    <section>
        <pre>$ sudo dnf install standard-test-roles</pre>
    </section>

    <section>
        <h3>Upstream demo / video</h3>
    </section>

    <!--<section data-background-video="standard_tests_demo.webm">
        <aside>
        </aside>
    </secion>-->

    <section>
        <h3>Tutorial</h3>
        <a href="https://fedoraproject.org/wiki/CI/Tests">fedoraproject.org/wiki/CI/Tests</a>
    </section>

    <section>
        <h3>Upstreaming Tests</h3>
        <a href="https://upstreamfirst.fedorainfracloud.org">upstreamfirst.fedorainfracloud.org</a>
    </section>


    <section>
        <h2><strong>Questions?
            <br><br>
            </strong></h2>
        <p><tt>#fedora-ci on Freenode</tt></p>
        <p><tt>https://pagure.io/fedora-ci/AtomicCi</tt></p>
        <p><tt></tt></p>
    </section>
</div>
</div>

<script src="../reveal/js/reveal.js"></script>
<script src="slides.js"></script>

</body>
</html>
